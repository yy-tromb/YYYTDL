<script>

const yturlInput=document.getElementById("yturlInput");
const submit=document.getElementById("submit");
const errorMsg=document.getElementById("errorMsg");
const errorGAS=document.getElementById("errorGAS");
const video=document.getElementsByTagName("video")[0];
const AVdetail=document.getElementById("AVdetail");
const AVout=document.getElementById("AVout");
const Vdetail=document.getElementById("Vdetail");
const Vout=document.getElementById("Vout");
const Adetail=document.getElementById("Adetail");
const Aout=document.getElementById("Aout");

/*
const dlurl=document.getElementById("dlurl");
const dlExe=document.getElementById("dlExe");
*/

yturlInput.addEventListener("keydown",e=>{
  if(e.key==="Enter"){
    submit.click();
  }
});

submit.addEventListener("click",e=>{
  const YTURL=yturlInput.value;
  if(YTURL!==""&&URLCheck(YTURL)===true){
    errorMsg.textContent="";
    errorGAS.textContent="";
    google.script.run.withSuccessHandler(showYT).getYT(YTURL);

  }else{
    errorMsg.textContent="エラーが発生しました。URLの確認や、このサイトを再読み込みを行ってください。";
  }
})

function URLCheck(q){
  let s=q.slice(0,8);
  let d=q.replace(/http:\/\/|https:\/\//,"").split("/")[0];
  if( (
        s.startsWith("https://") || s.startsWith("http://") 
      ) && (
        d==="www.youtube.com"||d==="m.youtube.com"||d==="youtu.be"
      )
    ){
    return true;
  }else{
    return false;
  }
}

function showYT(e){
  if(!!(JSON.parse(e).error)===true){
    errorMsg.textContent="GASでエラーが発生しました："+JSON.parse(e).error;
    return false;
  }
  const {formats,adaptiveFormats}=JSON.parse(e);
  if(formats===undefined || formats===null){
    errorMsg.textContent="なにが理由かは少しわかりませんが、動画と音声がまとまったものが取得できなくなりました。修正をお待ちください。";
    if(adaptiveFormats===undefined || adaptiveFormats===null ){
      errorMsg.textContent="動画と音声がまとまったものも、分かれているものも取得できませんでした。どうしましょう？w";
      return false;
    }
  }else{
      //~.formats

    if(formats.length>=2){
      formats[0]=formats[0].itag===22? formats[0] : formats[1].itag===22? formats[1] : formats[0]; 
      formats[1]=formats[1].itag===18? formats[1] : formats[0].itag===18? formats[0] : formats[1];
    }

    const fmt=new YTDataSet(formats);
      video.src=fmt.urls[0];
      console.log("formats",fmt);
      createOutput(fmt,AVout);
      VandA.open=true;
  }
    //~.adaptiveaFormats
    adaptive.fmt=adaptiveFormats;
    fmtSet(adaptive);
    console.log("adaptive",adaptive);
    createOutput(adaptive,AVonly);
    AVonly.open=true;
  }
}

function YTDataSet(obj){
  let fmt=obj.fmt;
  for(let i=0,len=fmt.length;i<len;i++){
    this.urls[i]=fmt[i].url;
    this.itags[i]=fmt[i].itag;
    this.q[i]=fmt[i].qualityLabel;
    this.qurl[fmt[i].qualityLabel]=fmt[i].url;
    this.mime[i]=fmt[i].mimeType;
    this.mimeOK[i]=video.canPlayType(fmt[i].mimeType);
    if(this.mimeOK[i]==="") this.mimeOK[i]="no"; 
  }
}

function createOutput(obj,place){
   while(place.firstChild){
    place.removeChild(place.firstChild);
   }
   let smr=document.createElement("summary");
   if(place===VandA){
    smr.textContent="動画＋音声";
   }else if(place===AVonly){
    smr.textContent="動画または音声のみ";
   }
   place.appendChild(smr);
   let fmt=obj.fmt;
   let urls=obj.urls;
  for(let i=0,len=fmt.length;i<len;i++){
    let a=document.createElement("a");
    a.classList.add("URLout");
    a.href=urls[i];
    a.textContent=obj.q[i];
    a.target="_blank";
    a.rel="noopener noreferrer";
    place.appendChild(a);
  }
}

/* CORS errorを回避するためGASのfetch使いたいがめんどい

dlExe.onclick=async ()=>{
  const gfetch=google.script.UrlFetchApp.fetch;
  const url=dlurl.value;
  const blobArr=[];
  for(let i=0;i<2**32;i=i+5_000_000){
    try{
      const res=await fetch(url+"&range="+i+"-"+(i+5_000_000-1));
      if(res.ok===true){
        blobArr.push(await res.blob());
      }else{
        break;
      }
    }catch(e){
      break;
    }
  }
  const blob=new Blob(blobArr,{type:blobArr[0].type});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  document.body.appendChild(a);
  a.click();
  a.onclick=()=>a.remove();
};

*/

</script>